<!DOCTYPE html>
<html>
<head>
    <title>Login</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        window.API_HOST = "{{ api_host | safe }}"; // API server URL
    </script>
</head>
<body>
   <h1>Login</h1>
   <form id="login-form">
      <label for="email">Email:</label>
      <input type="text" id="email" name="email"><br><br> <!-- Ensure field names align -->
      <label for="password">Password:</label>
      <input type="password" id="password" name="password"><br><br>
      <button type="button" id="login-button">Login</button>
   </form>

   <script>
      function setCookie(name, value, days) {
         const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toUTCString();
         document.cookie = `${name}=${value}; expires=${expires}; path=/`;
     }

    function login() {
        const email = $("#email").val();
        const password = $("#password").val();

        $.ajax({
           url: window.API_HOST + "/api/auth/login",
           method: "POST",
           headers: { 'Content-Type': 'application/json' },
           data: JSON.stringify({ email, password }),
           success: function(response) {
              if (response.token && response.pid) {
                 setCookie('Authorization', `${response.token}`, 7); // Save JWT as a cookie
                 localStorage.setItem('Authorization', `${response.token}`);
                 window.location.href = `/useradmin?onebox=${response.pid}`; // Redirect to a protected page
              } else {
                 alert("Login failed");
              }
           },
           error: function() {
              alert("Login failed");
           }
        });
    }

    $(document).ready(function() {
        $("#login-button").click(function() {
            login();
        });
    });
   </script>
</body>
</html>